<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Колесо Фортуны</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Форма имени -->
    <div id="name-form">
      <input type="text" id="username" placeholder="Введите ваше имя" />
      <button id="start">Начать</button>
    </div>

    <button id="spin" disabled>Spin</button>
    <span class="arrow"></span>
    <div class="container">
      <div class="one">Стикер</div>
      <div class="two">Кружка</div>
      <div class="three">Флешка</div>
      <div class="four">Шоколадка</div>
      <div class="five">Блокнот</div>
      <div class="six">Ручка</div>
      <div class="seven">Магнит</div>
      <div class="eight">Брелок</div>
    </div>

    <div id="result" class="result-box"></div>

    <script>
      let container = document.querySelector(".container");
      let btn = document.getElementById("spin");
      let number = Math.ceil(Math.random() * 1000);
      let clicks = 0;

      const PRIZES = [
        "Стикер",
        "Кружка",
        "Флешка",
        "Шоколадка",
        "Блокнот",
        "Ручка",
        "Магнит",
        "Брелок",
      ];

      // ВСТАВЬ URL своего Apps Script веб-приложения!
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQkONGcedpDjOIysusowqolO1AaP8x8nX3GuIqp09scozebsYKgen82yq2NGKuQIyaxg/exec";

      const params = new URLSearchParams(window.location.search);
      const userId = params.get("id");
      const resultDiv = document.getElementById("result");
      const nameForm = document.getElementById("name-form");
      const startBtn = document.getElementById("start");
      const usernameInput = document.getElementById("username");

      if (!userId) {
        resultDiv.textContent = "Ошибка: нет ID в ссылке!";
        btn.disabled = true;
      }

      // Проверка ID
      async function checkUser() {
        if (!userId) return;
        try {
          const res = await fetch(
            `${SCRIPT_URL}?id=${encodeURIComponent(userId)}`
          );
          const data = await res.json();

          if (data.status === "invalid") {
            resultDiv.textContent = "Ссылка недействительна.";
            btn.disabled = true;
            nameForm.style.display = "none";
          } else if (data.status === "used" && data.prize) {
            resultDiv.textContent = `Вы уже участвовали! Ваш приз: ${data.prize}`;
            btn.disabled = true;
            nameForm.style.display = "none";
          } else if (data.status === "ok") {
            resultDiv.textContent = "Введите имя и начните игру!";
            btn.disabled = true;
          } else {
            resultDiv.textContent = "Неизвестный ответ сервера.";
            btn.disabled = true;
          }
        } catch (e) {
          console.error(e);
          resultDiv.textContent = "Ошибка соединения. Попробуйте позже.";
          btn.disabled = true;
        }
      }
      checkUser();

      // Нажатие "Начать"
      startBtn.onclick = () => {
        const name = usernameInput.value.trim();
        if (!name) {
          alert("Введите имя!");
          return;
        }
        window.playerName = name;
        nameForm.style.display = "none";
        btn.disabled = false;
        resultDiv.textContent = "Теперь можете крутить колесо!";
      };

      // Вращение и отправка
      btn.onclick = async function () {
        clicks += 1;
        if (clicks > 1) return;

        container.style.transform = "rotate(" + number + "deg)";
        number += Math.ceil(Math.random() * 1000);

        const prizeIndex = Math.floor(Math.random() * PRIZES.length);
        const prize = PRIZES[prizeIndex];

        setTimeout(async () => {
          try {
            const res = await fetch(
              `${SCRIPT_URL}?id=${encodeURIComponent(
                userId
              )}&name=${encodeURIComponent(
                window.playerName
              )}&result=${encodeURIComponent(prize)}&ua=${encodeURIComponent(
                navigator.userAgent
              )}`
            );
            const data = await res.json();

            if (data.status === "ok") {
              resultDiv.textContent = `Поздравляем, ${window.playerName}! Ваш приз: ${data.prize}`;
              btn.disabled = true;
            } else if (data.status === "used") {
              resultDiv.textContent = `Вы уже участвовали! Ваш приз: ${data.prize}`;
              btn.disabled = true;
            } else if (data.status === "invalid") {
              resultDiv.textContent = "Ссылка недействительна.";
              btn.disabled = true;
            } else {
              resultDiv.textContent = `Ошибка: ${
                data.message || "неизвестная"
              }`;
            }
          } catch (e) {
            console.error(e);
            resultDiv.textContent = "Ошибка соединения со скриптом";
          }
        }, 5000);
      };
    </script>
  </body>
</html>

